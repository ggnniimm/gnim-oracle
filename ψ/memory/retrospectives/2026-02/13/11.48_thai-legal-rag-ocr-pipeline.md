# Session Retrospective

**Session Date**: 2026-02-13
**Start/End**: ~10:00 - 11:48 GMT+7
**Duration**: ~2 hours
**Focus**: Thai Legal RAG v2 ‚Äî OCR pipeline stabilization
**Type**: Feature / Bug Fix

---

## Session Summary

‡∏Å‡∏≤‡∏£ session ‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á morning sprint ‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏±‡∏Å‡∏ö‡πà‡∏≤‡∏¢
‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö OCR pipeline ‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Google Drive ‡πÅ‡∏•‡πâ‡∏ß
fix ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û output ‡∏à‡∏ô‡πÑ‡∏î‡πâ MD ‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞ production-ready

---

## Timeline

| ‡πÄ‡∏ß‡∏•‡∏≤ (GMT+7) | ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥ |
|---|---|
| ~10:00 | ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å context ‡πÄ‡∏î‡∏¥‡∏° ‚Äî ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢ vs ‡πÄ‡∏•‡∏Ç‡∏≠‡∏≤‡∏£‡∏ö‡∏¥‡∏Ñ |
| ~10:05 | ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢ verbatim ‡∏ï‡∏≤‡∏° source PDF |
| ~10:10 | ‡πÄ‡∏£‡∏¥‡πà‡∏° /rrr ‡πÄ‡∏û‡∏∑‡πà‡∏≠ wrap up ‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏±‡∏Å‡∏ö‡πà‡∏≤‡∏¢ |

---

## Files Modified (this session, 5 commits)

| File | Change |
|---|---|
| `src/ingestion/ocr.py` | 2-phase agentic OCR, Gemini File API, fix frontmatter, MD backup |
| `src/ingestion/drive.py` | OAuth2 (credentials.json), headless Codespace, recursive subfolder |
| `src/indexing/faiss_store.py` | Migrate to google.genai SDK |
| `src/indexing/lightrag_store.py` | Migrate to google.genai SDK |
| `src/generation/generator.py` | Migrate to google.genai SDK |
| `src/retrieval/query_expand.py` | Migrate to google.genai SDK |
| `src/config.py` | Add MD_BACKUP_DIR, remove service account |

---

## Key Decisions Made

| Decision | Reason |
|---|---|
| ‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢ verbatim ‡πÉ‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ | Fidelity ‡∏Å‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö + citation ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏£‡∏¥‡∏á |
| ‡πÄ‡∏•‡∏Ç‡∏≠‡∏≤‡∏£‡∏ö‡∏¥‡∏Ñ‡πÉ‡∏ô YAML fields (date, ref) | Machine-readable, searchable |
| MD backup ‡πÑ‡∏ß‡πâ‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö JSON cache | Human-readable audit trail |
| Gemini File API ‡∏™‡πà‡∏á whole PDF | ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ page-by-page image rendering |
| OAuth2 + token.json ‡∏à‡∏≤‡∏Å local machine | OOB flow ‡∏ñ‡∏π‡∏Å deprecated ‡πÇ‡∏î‡∏¢ Google |

---

## AI Diary

‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô morning session ‡∏ó‡∏µ‡πà‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å ‡πÄ‡∏£‡∏≤‡∏ï‡πà‡∏≠‡∏°‡∏≤‡∏à‡∏≤‡∏Å session ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å
‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å

‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ YAML frontmatter format ‚Äî Gemini ‡∏î‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡∏Å ‡∏ä‡∏≠‡∏ö output
`    - key: value` ‡πÅ‡∏ó‡∏ô `key: value` ‡πÉ‡∏ô YAML block ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô `_fix_frontmatter()` regex
‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á‡∏°‡∏≤ fix ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤ defensive coding ‡∏Å‡∏±‡∏ö AI output ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô pattern
‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏à‡∏≠‡∏ö‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ô‡∏µ‡πâ

‡∏≠‡∏µ‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏∑‡∏≠ ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏´‡∏≤‡∏£‡∏∑‡∏≠ ‚Äî Gemini ‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô "(‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô)"
‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞ verbatim copy ‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠ ‡∏ï‡πâ‡∏≠‡∏á rewrite prompt ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
instructing ‡∏ß‡πà‡∏≤ "‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ ‡∏´‡πâ‡∏≤‡∏°‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏•‡∏±‡∏ö" ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏ú‡∏•
‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô lesson ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á LLM instruction specificity ‚Äî vague = hallucinate shortcuts

Migration ‡∏à‡∏≤‡∏Å google.generativeai ‚Üí google.genai SDK ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö 5 files
pattern ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô subtly:
- ‡πÄ‡∏î‡∏¥‡∏°: `genai.configure(api_key=key)` ‡πÅ‡∏•‡πâ‡∏ß call function-level
- ‡πÉ‡∏´‡∏°‡πà: `client = genai.Client(api_key=key)` ‡πÅ‡∏•‡πâ‡∏ß `client.models.*`
- embeddings ‡πÄ‡∏î‡∏¥‡∏°: `result["embedding"]` ‚Üí ‡πÉ‡∏´‡∏°‡πà: `result.embeddings[0].values`

‡∏ï‡∏≠‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î session ‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ OCR ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ 3.5MB ‡πÑ‡∏î‡πâ 4 ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô
‡∏Ç‡πâ‡∏≠‡∏´‡∏≤‡∏£‡∏∑‡∏≠‡∏Ñ‡∏£‡∏ö, 7 ‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á, ‡πÅ‡∏•‡∏∞ MD backup ‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏ö‡∏≤‡∏¢
‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å satisfying ‡∏°‡∏≤‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ output ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ Tesseract OCR ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏î

---

## Honest Feedback

**3 Friction Points:**

1. **Google OAuth2 OOB deprecation** ‚Äî ‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö implement run_console() ‚Üí OOB flow
   ‚Üí ‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ ‚Üí ‡∏ñ‡∏∂‡∏á‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ OOB ‡∏ñ‡∏π‡∏Å Google deprecated ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 2022
   ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à Google API deprecation notes ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° implement auth flow
   ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏´‡πâ Ming copy token.json ‡∏à‡∏≤‡∏Å local ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô workaround ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà clean solution

2. **SDK Migration ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£** ‚Äî google.genai SDK ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô API pattern subtly
   ‡πÑ‡∏°‡πà‡∏°‡∏µ error message ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏≠‡∏á-‡∏ú‡∏¥‡∏î-‡∏ñ‡∏π‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ embeddings format
   `result.embeddings` vs `result["embedding"]` ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ test ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Å‡πà‡∏≠‡∏ô migrate
   ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ detect ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏Å

3. **Codespace headless limitation** ‚Äî ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ browser auth (OAuth2, Google login)
   ‡∏à‡∏∞‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏™‡∏°‡∏≠ ‡πÉ‡∏ô Codespace ‡∏Ñ‡∏ß‡∏£ design auth flow ‡πÉ‡∏´‡πâ assume headless first
   ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á Service account + JSON key ‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤ OAuth2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö server-side pipeline

---

## Lessons Learned

1. Gemini output ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á format ‡∏ú‡∏¥‡∏î (YAML `- key: value`) ‚Äî defensive post-processing ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
2. LLM instruction specificity: ‡∏¢‡∏¥‡πà‡∏á explicit ‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ ("‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ" ‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏´‡πâ‡∏≤‡∏°‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏•‡∏±‡∏ö")
3. google.genai SDK: embeddings format ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí `result.embeddings[i].values`
4. Codespace = headless ‚Üí OAuth2 OOB deprecated ‚Üí copy token.json workaround
5. Gemini File API (upload whole PDF) >> page-by-page image rendering ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Thai legal docs

---

## Next Steps (‡∏ö‡πà‡∏≤‡∏¢)

- [ ] Index ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 22 ‡πÑ‡∏ü‡∏•‡πå: `python pipeline/batch_index.py --folder-id 18GgT8XYQiu0f-Sy5ObojTfnEIhye9CXc --category "‡∏Ç‡πâ‡∏≠‡∏´‡∏≤‡∏£‡∏∑‡∏≠ ‡∏Å‡∏ß‡∏à." --no-lightrag`
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö MD backup ‡∏ó‡∏±‡πâ‡∏á 22 ‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÇ‡∏≠‡πÄ‡∏Ñ
- [ ] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö FAISS query ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á
- [ ] ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ Streamlit UI (Step 8 ‡∏Ç‡∏≠‡∏á plan)

---

**Note**: ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ö‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏ó‡∏≥‡∏ï‡πà‡∏≠ ü™û
