# Session Retrospective

**Session Date**: 2026-02-13
**Time**: ~08:30 - 10:13 GMT+7
**Duration**: ~100 min
**Focus**: Thai Legal RAG — Re-OCR old schema files + LightRAG indexing
**Type**: Bug Fix + Data Migration + Infra

---

## Session Summary

สองงานหลักในเซสชันนี้: (1) re-OCR 7 ไฟล์ที่ยังใช้ schema เก่า และ (2) index LightRAG ครั้งแรกกับ 24 ไฟล์ทั้งหมด ผ่าน bugs หลายชั้นก่อนจะเสร็จ

---

## Timeline

- **08:30** — ตรวจสอบว่า MD files บางตัวยังเป็น schema เก่า → พบ 8 ไฟล์ (17 ใหม่, 8 เก่า)
- **08:35** — Re-OCR 7 Drive files ด้วย schema ใหม่ (`document.md` + `002_กวจ_5892` = ไฟล์เดียวกัน)
- **08:40** — FAIL: OCR ดึง cache เก่า เพราะ deletion script ใช้นามสกุล `.md` แต่ cache จริงเป็น `.json` (16-char hex)
- **08:45** — ลบ cache ถูก re-OCR ใหม่ → 7/7 OK schema ใหม่ทั้งหมด
- **08:50** — ลบ `document.md` (ไฟล์ corrupt) → 24 MD files สะอาด
- **08:52** — Re-index FAISS → 637 chunks ✅
- **08:55** — เริ่ม LightRAG indexing → `ModuleNotFoundError: tiktoken` → install
- **09:00** — `ImportError: gpt_4o_mini_complete` (removed in v1.3.1) → ลบ import
- **09:02** — `ModuleNotFoundError: pipmaster` → install
- **09:05** — `KeyError: history_messages` → bug ใน lightrag v1.3.1 เอง → patch
- **09:08** — LightRAG indexing เริ่มทำงาน (~3.5 min/file)
- **09:08–10:08** — รอ background process 1:20:10 นาที
- **10:09** — เสร็จ: FAISS 637 vectors + LightRAG graph 87MB
- **10:13** — commit + push

---

## Files Modified

- `src/indexing/lightrag_store.py` — ลบ `gpt_4o_mini_complete` import
- `/usr/local/python/.../lightrag/lightrag.py` — patch `history_messages` KeyError (library bug)
- `data/md_backup/` — 7 ไฟล์ re-OCR'd, 1 ไฟล์ (document.md) ลบ

---

## AI Diary

เซสชันนี้มี pattern ที่น่าสนใจ: **การ migrate data ดูเรียบง่ายแต่มีชั้นซ้อนหลายชั้น**

เริ่มต้นด้วยงานที่ดูตรงไปตรงมา — "re-OCR 8 ไฟล์ที่มี schema เก่า" แต่แต่ละขั้นตอนมีกับดักรออยู่: OCR cache deletion ใช้ extension ผิด (`.md` แทน `.json`) ทำให้ OCR ดึง cache เก่ามาใช้ทั้งหมด ผลลัพธ์ดูเหมือน OK แต่ content ยังเป็น schema เก่า ต้องอ่าน config source code จึงเจอว่า `_cache_path` ใช้ 16-char hex `.json` ไม่ใช่ full SHA256 `.md`

LightRAG มีชั้นปัญหาของตัวเองอีกสี่ชั้น: tiktoken → gpt_4o_mini_complete → pipmaster → history_messages KeyError ชั้นสุดท้ายเป็น bug ใน library เอง ซึ่งน่าแปลกใจ เพราะ lightrag v1.3.1 น่าจะ stable แล้ว แต่ดูเหมือนมีการ refactor pipeline_status ที่ทำให้ initialization path หายไป

สิ่งที่รู้สึกพอใจที่สุดคือตอน LightRAG เริ่มทำงาน และดู tqdm progress ค่อยๆ เดินไปทีละ batch ทุก ~3-4 นาที มันเหมือนดูเครื่องจักรทำงาน รู้ว่าข้างในมัน extract entities, map relationships, embed vectors ทั้งหมดผ่าน Gemini API หลายสิบ calls ต่อไฟล์

สิ่งที่ค้างใจคือ: เรายังไม่รู้ว่า LightRAG จะให้ผลลัพธ์ดีขึ้นจริงๆ ไหม graph มี 87MB ซึ่งใหญ่กว่าที่คาดสำหรับ 24 ไฟล์ แต่นั่นก็แปลว่า entity extraction ทำงานได้มากพอสมควร การทดสอบ query จะบอกความจริงได้

---

## Honest Feedback

**สามจุดที่รู้สึกฝืด:**

1. **OCR cache key format ไม่ชัดเจน** — ไม่มีที่ไหนใน code หรือ README ที่บอกว่า cache file ใช้ชื่อว่าอะไร (16-char hex `.json`) ต้องอ่าน `_cache_path()` function เอง ถ้ามี comment หรือ helper `clear_cache(file_id)` จะดีกว่ามาก กับดักนี้จะเกิดซ้ำถ้าต้อง invalidate cache ในอนาคต

2. **LightRAG indexing ช้ามากและ opaque** — 1:20 นาทีสำหรับ 24 ไฟล์ ไม่มี progress detail ว่าแต่ละไฟล์ทำอะไรอยู่ (extract entities? embed? graph build?) ถ้า fail ตรงกลางก็ไม่รู้ว่า resume ได้ไหม ต้องเริ่มใหม่หรือเปล่า ต้องการ visibility มากกว่านี้

3. **Library bugs ที่ต้อง patch source code** — การ patch `/usr/local/python/.../lightrag/lightrag.py` ตรงๆ เป็น workaround ที่ brittle มาก ถ้า codespace reset หรือ upgrade lightrag bug จะกลับมา ควรจะ pin version หรือ fork ใน requirements.txt แทน

---

## Lessons Learned

1. **OCR cache key = `sha256(file_id)[:16].hex() + ".json"`** ไม่ใช่ full hash และไม่ใช่ `.md`
2. **LightRAG v1.3.1 bug**: `pipeline_status` ต้อง init `history_messages: []` ก่อน `del` — patch line 846 ใน `lightrag.py`
3. **`gpt_4o_mini_complete` removed in lightrag v1.3.1** — ใช้ custom `llm_model_func` ได้เลย ไม่ต้อง import
4. **Data migration = หลายชั้น** — ต้อง verify ทุก layer: cache → OCR output → saved file → index

---

## Next Steps

1. **ทดสอบ query ด้วย LightRAG** — เปรียบเทียบ FAISS-only vs FAISS+LightRAG
2. **Pin lightrag bug fix** — บันทึกใน requirements หรือเพิ่ม post-install patch script
3. **Streamlit UI** — interactive query interface
4. **`clear_cache(file_id)` helper** — เพิ่มใน `ocr.py` ป้องกัน cache invalidation confusion
