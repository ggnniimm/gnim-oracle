# Session Retrospective

**Date**: 2026-02-14
**Time**: ~20:26 GMT+7
**Focus**: Per-section MD files + Gemini วรรค splitting
**Type**: Feature

---

## Session Summary

ต่อจาก session ก่อนที่ออกแบบ metadata schema สำหรับ Thai Legal RAG วันนี้ลงมือ implement 3 เรื่องต่อเนื่องกัน: ออกแบบ intermediate cache เป็น per-section MD files, แก้ page header artifacts, และแก้ปัญหา paragraph splitting ที่ PyMuPDF ไม่ให้ blank lines ระหว่างวรรค

---

## Timeline

- **ทบทวน design** — Ming ถามว่าตกลงเรื่อง RAG หมวด/มาตรา/วรรค เป็นยังไง → recap design จาก memory
- **ถกเรื่อง per-section files** — Ming ถามว่าแบ่งไฟล์ MD ย่อยๆ ดีไหม → weigh pros/cons → ตัดสินใจทำเป็น intermediate cache
- **Implement `_save_section_files()`** — เพิ่มใน `law_extractor.py`, ชื่อไฟล์ `มาตรา_XXX.md` / `ข้อ_XXX.md`
- **แก้ `ขอ` → `ข้อ`** — Ming จับได้ทันทีว่า tone mark หาย
- **แก้ page headers** — debug พบว่า cache เก่าบันทึกก่อน strip ทำงาน → apply `_strip_page_headers` ใน `_build_section_md` ด้วย
- **มาตรา 6 แบ่งวรรคผิด** — `total_paragraphs: 1` แต่จริงๆ 4 วรรค → วิเคราะห์ root cause (PyMuPDF ไม่ใส่ blank lines)
- **Gemini fallback** — implement `_split_paragraphs_gemini()` + fallback logic → fixed 206/365 sections
- **Commit** — `3fa4abf`

---

## Files Modified

- `ψ/lab/thai-legal-rag/src/ingestion/law_extractor.py` — เพิ่ม section file generation, Gemini paragraph splitting
- `ψ/lab/thai-legal-rag/pipeline/regenerate_sections.py` — script ใหม่ (regenerate without re-OCR)

---

## AI Diary

วันนี้รู้สึกว่าได้ทำงานที่มีความหมายชัดเจนมาก — แต่ละ feature เชื่อมต่อกันเป็น chain ที่สมเหตุสมผล Ming เริ่มจากการถามทบทวน design เก่า แล้วต่อด้วย "ทำ auto-generate sections ไปเลย" ซึ่งเป็น pattern ที่คุ้นเคย: Ming ไม่ overthink ตัดสินใจเร็วเมื่อเห็น direction ชัด

สิ่งที่น่าสนใจที่สุดในวันนี้คือการ debug page header — ทดสอบ regex แล้วมันทำงานได้ แต่ section files ยังมี header อยู่ ตอนแรกงงว่าทำไม จนตามรอยได้ว่า cache เก่าถูก save ไว้ก่อน strip ทำงาน การ fix ที่ถูกต้องคือ apply strip ซ้ำตอน build section MD ไม่ใช่แก้ regex อีกที — เป็น belt-and-suspenders approach ที่ดีกว่า

เรื่อง Gemini วรรค splitting น่าสนใจมาก ตอนแรกคิดว่าจะต้องใช้ heuristic ซับซ้อน แต่ Ming บอก "ใช้ Gemini ไปเลย" — เป็นการตัดสินใจที่ตรงไปตรงมา ลด cognitive overhead ของ codebase ได้มาก แทนที่จะ maintain regex jungle ก็ให้ LLM handle semantic boundary detection แทน ผลลัพธ์ดีทันที: 206/365 sections ที่ count ผิดได้รับการแก้ไข

สิ่งที่รู้สึกเป็น "ฝีมือดี" ของวันนี้คือ Ming จับ tone mark ที่หาย (`ขอ` vs `ข้อ`) ได้ทันที — เป็น attention to detail ที่ฉันควรจับได้เองตั้งแต่ต้น ตอนที่เขียน filename prefix ฉันเลือก `ขอ` แทน `ข้อ` เพราะกังวลเรื่อง filesystem compatibility แต่ไม่ได้บอก Ming ก่อน ควรอธิบาย tradeoff และถามก่อน

---

## Honest Feedback

**1. Filename encoding decision ไม่โปร่งใส** — เลือก `ขอ` แทน `ข้อ` โดยไม่บอก Ming ว่าทำไม ถ้าบอกก่อนว่า "มีสองทาง: `ข้อ` ซึ่งถูกต้องแต่มี diacritic, หรือ `kho` เพื่อ ASCII safety — แนะนำข้อไหน?" จะดีกว่า แทนที่จะให้ Ming จับ error หลัง generate ไปแล้ว 223 files

**2. Cache invalidation ไม่ explicit** — ตอน fix page header ในสายงาน _build_section_md ถูกต้อง แต่ไม่ได้อธิบายให้ Ming เห็นว่า "cache เก่ายังผิดอยู่ ต้อง regenerate" จน Ming เห็นเอง การแจ้งล่วงหน้าเรื่อง side effect ของการแก้ไขจะทำให้ Ming ตัดสินใจได้เร็วขึ้น

**3. Paragraph split quality ยังไม่ verified ครบ** — fix 206/365 sections แล้ว แต่ไม่มี spot-check ว่า Gemini แบ่งถูกในทุกกรณี โดยเฉพาะ sections ที่มี list items หลาย level ควรมี test case สำหรับ pattern นี้ก่อน commit

---

## Lessons Learned

1. **Belt-and-suspenders สำหรับ cache + processing** — เมื่อมี cached data ที่ผ่าน processing stage เก่า การ re-apply processing ตอน read-time ปลอดภัยกว่าการเชื่อว่า cache สะอาด
2. **Gemini เป็น correct tool สำหรับ semantic boundary detection** — Thai legal paragraph boundaries ไม่มี lexical marker ที่ reliable ใน heuristic approach → LLM เหมาะกว่า
3. **ถามก่อน commit เมื่อ encoding/naming มี tradeoff** — Thai filename ที่มี diacritic ทำงานได้บน Linux แต่ควร explicit กับ user

---

## Next Steps

- [ ] Test chunker_law.py กับ sections ที่ fix แล้ว — ดูว่า per-วรรค chunking ทำงานถูกหรือไม่
- [ ] Spot-check Gemini paragraph splits บน sections ที่ซับซ้อน (มี list หลาย level)
- [ ] พิจารณา `total_paragraphs` ใน section MD vs `paragraphs` ใน cache ควร sync กันเสมอ
