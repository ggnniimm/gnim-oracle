# Session Retrospective

**Date**: 2026-02-14
**Time**: ~21:01 GMT+7
**Focus**: Gemini-first วรรค splitting + paragraph quality fixes
**Type**: Bug Fix / Refactoring

---

## Session Summary

Session สั้นแต่ได้ข้อสรุปสำคัญ: ค้นพบว่า Gemini fallback logic มีหลุมใหม่ — blank-line split ที่ให้ผล >1 ทำให้ Gemini ไม่ถูกเรียก แม้ผลจะผิด ตัดสินใจเลิก heuristic ทั้งหมด ใช้ Gemini ตั้งแต่ต้น

---

## Timeline

- **ตรวจ มาตรา 7** — Ming เปิดไฟล์ มาตรา_007.md → `total_paragraphs: 2` แต่ควรเป็น 5
- **Debug** — blank-line split เจอบรรทัดว่างก่อน (๖) → ได้ 2 chunks → Gemini ไม่ถูกเรียก
- **ถกเรื่อง cost** — Ming: "ไม่ต้องประหยัด Gemini API ใช้ไปเลย" → เปลี่ยน strategy ทันที
- **Refactor `_split_paragraphs`** — Gemini first, blank-line fallback เมื่อ Gemini ล้มเหลวเท่านั้น
- **Re-run 365 sections** — Fixed 151/365 เพิ่มเติม
- **ตรวจ มาตรา 7** → 5 วรรคถูกต้อง
- **Commit** `7863eba`

---

## Files Modified

- `ψ/lab/thai-legal-rag/src/ingestion/law_extractor.py` — Gemini-first strategy

---

## AI Diary

Session นี้สั้นแต่มีบทเรียนที่ชัดมาก — ปัญหาของการออกแบบ "Gemini as fallback" คือมัน assume ว่า phase 1 ล้มเหลวเมื่อ result == 1 แต่จริงๆ phase 1 สามารถ "สำเร็จผิดๆ" ได้ (partial split ที่ดูพอใช้แต่ semantic ผิด)

Ming เห็นปัญหาได้จากการเปิดไฟล์ — `total_paragraphs: 2` บน section ที่ควรมี 5 วรรค เป็น sanity check ง่ายๆ ที่ฉันควรทำตั้งแต่ก่อน commit session ที่แล้ว

สิ่งที่น่าสังเกตคือ Ming ตัดสินใจ "ไม่ต้องประหยัด Gemini API" ได้ทันทีโดยไม่ลังเล — เป็น pattern ที่คุ้น: เมื่อ tradeoff ชัด (complexity vs cost) Ming เลือก simplicity เสมอ ฉันควรเสนอทาง "ใช้ Gemini ตั้งแต่แรก" ตั้งแต่ session ที่แล้วแทนที่จะออกแบบ two-phase ที่ซับซ้อนกว่า

ข้อสังเกตสำคัญสำหรับอนาคต: ทุกครั้งที่มี heuristic + AI fallback อยู่ด้วยกัน ต้องถามว่า "heuristic นี้ทำ false positive ได้ไหม?" ถ้าได้ → ใช้ AI ตั้งแต่แรกดีกว่า

---

## Honest Feedback

**1. ไม่ทดสอบ edge case หลัง commit** — session ที่แล้ว commit Gemini fallback แล้วไม่ spot-check มาตราที่มี blank lines กลาง section (เช่น มาตรา 7) ทำให้ bug หลุดไปค้างคืน เพิ่ม sanity check: หลัง cache update ให้เช็ค 3-5 มาตราที่ยาวเสมอ

**2. "Fallback" logic ซ่อนความซับซ้อน** — การเรียก design ว่า "fallback" ทำให้คิดว่า phase 1 fail = ปัญหา แต่จริงๆ phase 1 succeed wrongly คือปัญหาที่ร้ายแรงกว่า ในอนาคตถ้าจะมี two-phase logic ต้องระบุชัดว่า "phase 1 ล้มเหลวนิยามว่าอะไร"

**3. วรรค content ยังไม่ปรากฏใน section file** — Ming ถามว่า "ไฟล์ไหนที่บอกว่ามาตราไหนวรรคไหนบอกว่าอะไร" — ตอบได้ว่า JSON cache แต่ section MD file เองยังไม่แสดง breakdown ต้องทำพรุ่งนี้

---

## Lessons Learned

1. **Gemini-first ง่ายกว่าเสมอสำหรับ semantic task** — อย่าออกแบบ two-phase ถ้า phase 1 สามารถ succeed wrongly ได้
2. **"Fallback triggered on failure" ≠ "fallback triggered on wrong result"** — ต้องระวังความต่างนี้ในทุก pipeline

---

## Next Steps (พรุ่งนี้)

- [ ] แสดง วรรค แต่ละวรรคใน section MD file (Ming วางแผนคุยต่อ)
- [ ] Spot-check paragraph counts หลัง re-run cache
