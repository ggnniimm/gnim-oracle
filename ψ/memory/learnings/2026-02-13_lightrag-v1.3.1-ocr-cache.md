# Lesson: LightRAG v1.3.1 + OCR Cache Key Format

**Date**: 2026-02-13
**Source**: Thai Legal RAG re-OCR + LightRAG indexing session

---

## 1. OCR Cache Key Format

Cache files ใน `data/ocr_cache/` ใช้รูปแบบ: `sha256(file_id).hexdigest()[:16] + ".json"`

**ผิด** (ทำให้ deletion ไม่ work):
```python
cache_file = OCR_CACHE_DIR / f"{hashlib.sha256(fid.encode()).hexdigest()}.md"
```

**ถูก**:
```python
cache_file = OCR_CACHE_DIR / f"{hashlib.sha256(fid.encode()).hexdigest()[:16]}.json"
```

หรือใช้ `_cache_path(file_id)` จาก `src/ingestion/ocr.py` โดยตรง

---

## 2. LightRAG v1.3.1 — history_messages KeyError

Bug ใน `lightrag/lightrag.py` line ~846: `del pipeline_status["history_messages"][:]` fail เมื่อ `pipeline_status` เป็น empty dict (first run)

**Patch**:
```python
# Before: del pipeline_status["history_messages"][:]
if "history_messages" not in pipeline_status:
    pipeline_status["history_messages"] = []
del pipeline_status["history_messages"][:]
```

---

## 3. LightRAG v1.3.1 — removed imports

`from lightrag.llm import gpt_4o_mini_complete` — removed in v1.3.1
ถ้าใช้ custom LLM function ลบ import นี้ออกได้เลย

---

## 4. LightRAG Dependencies (v1.3.1)

ต้อง install เพิ่ม:
- `tiktoken` — ไม่ได้ติดมากับ lightrag-hku
- `pipmaster` — ไม่ได้ติดมา (auto-install networkx, graspologic, nano-vectordb)

---

## 5. LightRAG Indexing Performance

- ~3-4 นาที/ไฟล์ (ขึ้นกับขนาด)
- 24 ไฟล์ → ~80 นาที
- Output: graph .graphml + vdb_entities/relationships/chunks .json (รวม ~87MB)
- Resumable: ใช่ — ถ้า restart จะข้าม docs ที่ index แล้วแล้ว (kv_store_doc_status)
